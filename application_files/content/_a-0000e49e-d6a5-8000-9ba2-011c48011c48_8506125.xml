<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<contentHaul xmlns:a="http://www.appian.com/ae/types/2009">
    <versionUuid>_a-0000e4a8-06eb-8000-9ba2-011c48011c48_8583393</versionUuid>
    <rule>
        <name>RC_IF_Geografia</name>
        <uuid>_a-0000e49e-d6a5-8000-9ba2-011c48011c48_8506125</uuid>
        <description>Interfaz que contiene la sección Geografía e Impacto del alta de incidencias</description>
        <parentUuid>_a-0000e480-7e67-8000-9ba2-011c48011c48_8288662</parentUuid>
        <visibility>
            <advertise>false</advertise>
            <hierarchy>true</hierarchy>
            <indexable>true</indexable>
            <quota>false</quota>
            <searchable>true</searchable>
            <system>false</system>
            <unlogged>false</unlogged>
        </visibility>
        <definition>load(
  local!nulo,
  /*PAGINACIONES*/
  local!pagingBase: #"SYSTEM_SYSRULES_pagingInfo"(1,5),
  local!pagingGeografia: local!pagingBase,
  local!pagingImpacto: local!pagingBase,
  /*variables donde se guarda la info para luego añadir al grid*/
  local!Geografia: 'type!{urn:com:appian:types:RC}RC_CDT_Geografia'(),
  local!geografiasGuardadas,
  local!diccionarioGeografia: {},
  local!subclientes,
  local!Impacto: 'type!{urn:com:appian:types:RC}RC_CDT_Impacto'(),
  local!IdSubImpacto,
  /*QUERIES*/
  local!queryGeografias: #"_a-0000e49e-d6a5-8000-9ba2-011c48011c48_8515286"(ctlEstado: true()),
  local!queryTiposImpacto: #"_a-0000e4a8-06eb-8000-9ba2-011c48011c48_8559874"(ctlEstado: true()),
  local!queryImpactosIdioma: todatasubset(
    if(
      ri!idiomaEsp,
      #"SYSTEM_SYSRULES_forEach"(
        local!queryTiposImpacto,
        {
          Id: fv!item.Id,
          Nombre: fv!item.NombreEsp
        }
      ),
      #"SYSTEM_SYSRULES_forEach"(
        local!queryTiposImpacto,
        {
          Id: fv!item.Id,
          Nombre: fv!item.NombreEng
        }
      )
    )
  ),
  local!queryDivisas: #"_a-0000e4a8-06eb-8000-9ba2-011c48011c48_8571461"(ctlEstado: true()),
  /*LABELS*/
  local!labelsAux,
  local!labelsGeografias: if(
    local!queryGeografias.totalCount = 0,
    {},
    union(local!queryGeografias.data.Geografia,local!queryGeografias.data.Geografia)
  ),
  local!labelsClientes: {},
  local!labelsSubclientes: {},
  /*VALUES*/
  local!valuesAux,
  local!valuesGeografias: if(
    local!queryGeografias.totalCount = 0,
    {},
    union(local!queryGeografias.data.IdGeografia,local!queryGeografias.data.IdGeografia)
  ),
  local!valuesClientes: {},
  local!valuesSubclientes: {},
  
  local!geografiaSeleccionada,
  local!clienteSeleccionado,
  
  
  local!mostrarEconomico: false(),
  local!mostrarNumero: false(),
  
  local!mostrarMasInfo,
  with(
    local!mostrarGeografia: if(
      #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Incidencia.DatosGenerales.EventoRiesgosPropiosHeracles),
      true(),
      not(ri!Incidencia.DatosGenerales.EventoRiesgosPropiosHeracles)
    ),
    local!queryProcesos: if(
      #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Incidencia.Direcciones),
      todatasubset({}),
      #"_a-0000e4a8-06eb-8000-9ba2-011c48011c48_8570106"(IdDireccion: ri!Incidencia.Direcciones.IdDireccionArea)
    ),
    {
      #"SYSTEM_SYSRULES_sectionLayout_v1"(
        label: index(ri!labels, "incidencia.geografia.seccion"),
        contents: {
          #"SYSTEM_SYSRULES_boxLayout"(
            label: index(ri!labels, "incidencia.geografia.geografia"),
            contents: {
              #"SYSTEM_SYSRULES_richTextDisplayField"(
                label: index(ri!labels, "general.no-aplica-long"),
                labelPosition: "ABOVE",
                value: {
                  #"SYSTEM_SYSRULES_richTextItem_v1"(
                    text: {index(ri!labels, "incidencia.geografia.warning.no-aplica")}
                  )
                },
                showWhen: not(local!mostrarGeografia)
              ),
              #"SYSTEM_SYSRULES_sideBySideLayout"(
                items: {
                  #"SYSTEM_SYSRULES_sideBySideItem"(
                    item: #"SYSTEM_SYSRULES_dropdownField"(
                      label: index(ri!labels, "incidencia.geografia.geografia"),
                      labelPosition: "ABOVE",
                      placeholderLabel: index(ri!labels,"general.placeholder-dropdown"),
                      choiceLabels: {
                        local!labelsGeografias
                      },
                      choiceValues: {
                        local!labelsGeografias
                      },
                      value: local!geografiaSeleccionada,
                      saveInto: {
                        local!geografiaSeleccionada,
                        a!save(
                          {local!clienteSeleccionado,local!subclientes},
                          null
                        ),
                        if(
                          #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!geografiaSeleccionada),
                          a!save(local!nulo,null),
                          {
                            a!save(
                              local!labelsAux,
                              index(
                                local!queryGeografias.data.Cliente,
                                wherecontains(
                                  tostring(local!geografiaSeleccionada),
                                  touniformstring(local!queryGeografias.data.Geografia)
                                ),
                                null
                              )
                            ),
                            a!save(
                              local!labelsClientes,
                              union(local!labelsAux,local!labelsAux)
                            )
                            /*,*/
                            /*a!save(*/
                              /*local!valuesAux,*/
                              /*index(*/
                                /*local!queryGeografias.data.IdCliente,*/
                                /*wherecontains(*/
                                  /*local!geografiaSeleccionada,*/
                                  /*tointeger(local!queryGeografias.data.IdGeografia)*/
                                /*),*/
                                /*null*/
                              /*)*/
                            /*),*/
                            /*a!save(*/
                              /*local!valuesClientes,*/
                              /*union(local!valuesAux,local!valuesAux)*/
                            /*)*/
                          }
                        )
                      },
                      validations: {}
                    )
                  ),
                  #"SYSTEM_SYSRULES_sideBySideItem"(
                    item: #"SYSTEM_SYSRULES_dropdownField"(
                      label: index(ri!labels, "incidencia.geografia.cliente"),
                      labelPosition: "ABOVE",
                      placeholderLabel: index(ri!labels,"general.placeholder-dropdown"),
                      choiceLabels: {
                        local!labelsClientes
                      },
                      choiceValues: {
                        local!labelsClientes
                      },
                      value: local!clienteSeleccionado,
                      saveInto: {
                        local!clienteSeleccionado,
                        a!save(local!subclientes,null),
                        if(
                          #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!clienteSeleccionado),
                          a!save(local!nulo,null),
                          {
                            a!save(
                              local!labelsAux,
                              index(
                                local!queryGeografias.data.Subcliente,
                                wherecontains(
                                  tostring(local!clienteSeleccionado),
                                  touniformstring(local!queryGeografias.data.Cliente)
                                ),
                                null
                              )
                            ),
                            a!save(
                              local!labelsSubclientes,
                              union(local!labelsAux,local!labelsAux)
                            )
                            ,
                            a!save(
                              local!valuesAux,
                              index(
                                local!queryGeografias.data.IdSubcliente,
                                wherecontains(
                                  tostring(local!clienteSeleccionado),
                                  touniformstring(local!queryGeografias.data.Cliente)
                                ),
                                null
                              )
                            ),
                            a!save(
                              local!valuesSubclientes,
                              union(local!valuesAux,local!valuesAux)
                            )
                          }
                        )
                      },
                      disabled: #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!geografiaSeleccionada),
                      validations: {}
                    )
                  ),
                  #"SYSTEM_SYSRULES_sideBySideItem"(
                    item: #"SYSTEM_SYSRULES_multipleDropdownField"(
                      label: index(ri!labels, "incidencia.geografia.subcliente"),
                      labelPosition: "ABOVE",
                      choiceLabels: {
                        local!labelsSubclientes
                      },
                      choiceValues: {
                        local!valuesSubclientes
                      },
                      value: local!subclientes,
                      saveInto: {
                        local!subclientes
                      },
                      disabled: #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!clienteSeleccionado),
                      validations: {}
                    )
                  ),
                  #"SYSTEM_SYSRULES_sideBySideItem"(
                    item: #"SYSTEM_SYSRULES_richTextDisplayField"(
                      label: "Add",
                      labelPosition: "COLLAPSED",
                      value: {
                        #"SYSTEM_SYSRULES_richTextIcon"(
                          icon: "plus",
                          caption: index(ri!labels, "general.añadir"),
                          link: #"SYSTEM_SYSRULES_dynamicLink"(
                            value: #"SYSTEM_SYSRULES_forEach"(
                              local!subclientes,
                              if(
                                not(
                                  contains(
                                    tointeger(index(ri!Geografias,"IdSubcliente",{})),
                                    tointeger(fv!item)
                                  )
                                ),
                                'type!{urn:com:appian:types:RC}RC_CDT_Geografia'(
                                  IdSubcliente: fv!item,
                                  IdIncidencia: ri!Incidencia.DatosGenerales.IdIncidencia,
                                  ctlFechaModificacion: now(),
                                  ctlUsuarioModificacion: loggedInUser(),
                                  ctlFechaCreacion: now(),
                                  ctlUsuarioCreacion: loggedInUser(),
                                  ctlEstado: true()
                                ),
                                updatecdt(
                                  index(ri!Geografias, wherecontains(tointeger(fv!item), tointeger(index(ri!Geografias,"IdSubcliente",{})))),
                                  {
                                    ctlFechaModificacion: now(),
                                    ctlUsuarioModificacion: loggedInUser(),
                                    ctlEstado: true()
                                  }
                                )
                              )
                            ),
                            saveInto: {
                              local!geografiasGuardadas,
                              #"SYSTEM_SYSRULES_forEach"(
                                local!geografiasGuardadas,
                                if(
                                  not(
                                    contains(
                                      tointeger(index(ri!Geografias,"IdSubcliente",{})),
                                      tointeger(fv!item.IdSubcliente)
                                    )
                                  ),
                                  a!save(
                                    ri!Geografias,
                                    append(
                                      ri!Geografias,
                                      fv!item
                                    )
                                  ),
                                  a!save(
                                    ri!Geografias[wherecontains(tointeger(fv!item.IdSubcliente), tointeger(index(ri!Geografias,"IdSubcliente",{})))],
                                    fv!item
                                  )
                                )
                              ),
                              a!save(
                                {local!geografiaSeleccionada, local!clienteSeleccionado, local!subclientes},
                                null
                              )
                            }
                          ),
                          size: "MEDIUM"
                        )
                      }
                    ),
                    width: "MINIMIZE",
                    showWhen: {
                      not(#"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!subclientes))
                    }
                  )
                },
                alignvertical: "MIDDLE",
                showWhen: local!mostrarGeografia
              ),
              with(
                local!diccionarioGrid: if(
                  local!queryGeografias.totalCount = 0,
                  {},
                  #"SYSTEM_SYSRULES_forEach"(
                    ri!Geografias,
                    {
                      IdSubcliente: fv!item.IdSubcliente,
                      Geografia: tostring(
                        index(
                          local!queryGeografias.data.Geografia,
                          wherecontains(
                            tointeger(fv!item.IdSubcliente),
                            tointeger(local!queryGeografias.data.IdSubcliente)
                          )
                        )
                      ),
                      Cliente: tostring(
                        index(
                          local!queryGeografias.data.Cliente,
                          wherecontains(
                            tointeger(fv!item.IdSubcliente),
                            tointeger(local!queryGeografias.data.IdSubcliente)
                          )
                        )
                      ),
                      Subcliente: tostring(
                        index(
                          local!queryGeografias.data.Subcliente,
                          wherecontains(
                            tointeger(fv!item.IdSubcliente),
                            tointeger(local!queryGeografias.data.IdSubcliente)
                          )
                        )
                      )
                    }
                  )
                ),
                local!datasubset: todatasubset(local!diccionarioGrid,local!pagingGeografia),
                #"SYSTEM_SYSRULES_gridField"(
                  label: "Tabla geografía",
                  labelPosition: "COLLAPSED",
                  totalCount: local!datasubset.totalCount,
                  columns: {
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.geografia"),
                      field: "Geografia",
                      data: {index(local!datasubset.data,"Geografia",{})}
                    ),
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.cliente"),
                      field: "Cliente",
                      data: {index(local!datasubset.data,"Cliente",{})}
                    ),
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.subcliente"),
                      field: "Subcliente",
                      data: {index(local!datasubset.data,"Subcliente",{})}
                    ),
                    #"SYSTEM_SYSRULES_gridImageColumn_v1"(
                      label: "",
                      data: if(
                        local!datasubset.totalCount = 0,
                        {},
                        #"SYSTEM_SYSRULES_forEach"(
                          local!datasubset.data,
                          #"SYSTEM_SYSRULES_documentImage"(
                            document: #"SYSTEM_SYSRULES_iconIndicator"("REMOVE"),
                            caption: index(ri!labels,"general.eliminar"),
                            link: #"SYSTEM_SYSRULES_dynamicLink"(
                              value: remove(ri!Geografias, wherecontains(tointeger(fv!item.IdSubcliente), ri!Geografias.IdSubcliente)),
                              saveInto: {
                                a!save(
                                  local!pagingGeografia.startIndex,
                                  if(
                                    and(
                                      local!datasubset.totalCount = local!pagingGeografia.startIndex,
                                      not(local!pagingGeografia.startIndex = 1)
                                    ),
                                    local!pagingGeografia.startIndex - local!pagingGeografia.batchSize,
                                    local!pagingGeografia.startIndex
                                  )
                                ),
                                ri!Geografias
                              }
                            )
                          )
                        )
                      ),
                      size: "ICON"
                    )
                  },
                  value: local!pagingGeografia,
                  saveInto: {
                    local!pagingGeografia
                  },
                  showWhen: local!mostrarGeografia,
                  validations: {},
                  shadeAlternateRows: true
                )
              )
            },
            style: "STANDARD",
            isCollapsible: true(),
            isInitiallyCollapsed: true(),
            marginBelow: "STANDARD"
          ),
          #"SYSTEM_SYSRULES_boxLayout"(
            label: index(ri!labels, "incidencia.geografia.impacto-proceso-afectado"),
            contents: {
              #"SYSTEM_SYSRULES_columnsLayout"(
                columns: {
                  #"SYSTEM_SYSRULES_columnLayout"(
                    contents: {
                      #"SYSTEM_SYSRULES_dropdownField"(
                        label: index(ri!labels, "incidencia.geografia.geografia-cliente-sub"),
                        labelPosition: "ABOVE",
                        placeholderLabel: index(ri!labels,"general.placeholder-dropdown"),
                        choiceLabels: {
                          if(
                            #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Geografias),
                            {},
                            #"SYSTEM_SYSRULES_forEach"(
                              ri!Geografias,
                              joinarray(
                                {
                                  index(local!queryGeografias.data.Geografia,fv!item.IdSubcliente),
                                  index(local!queryGeografias.data.Cliente,fv!item.IdSubcliente),
                                  index(local!queryGeografias.data.Subcliente,fv!item.IdSubcliente)
                                },
                                "-"
                              )
                            )
                          )
                        },
                        choiceValues: {
                          if(
                            #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Geografias),
                            {},
                            ri!Geografias.IdSubcliente
                          )
                        },
                        value: local!IdSubImpacto,
                        saveInto: {local!IdSubImpacto},
                        disabled: #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Geografias),
                        validations: {}
                      )
                    },
                    showWhen: local!mostrarGeografia
                  ),
                  #"SYSTEM_SYSRULES_columnLayout"(
                    contents: {
                      #"SYSTEM_SYSRULES_dropdownField"(
                        label: index(ri!labels, "incidencia.geografia.tipo-impacto"),
                        labelPosition: "ABOVE",
                        placeholderLabel: index(ri!labels,"general.placeholder-dropdown"),
                        choiceLabels: {
                          index(local!queryImpactosIdioma.data,"Nombre",{})
                        },
                        choiceValues: {
                          index(local!queryImpactosIdioma.data,"Id",{})
                        },
                        value: local!Impacto.TipoImpacto,
                        saveInto: {
                          local!Impacto.TipoImpacto,
                          a!save(
                            local!mostrarEconomico,
                            or(
                              local!Impacto.TipoImpacto = 1,
                              local!Impacto.TipoImpacto = 2
                            )
                          ),
                          a!save(
                            local!mostrarNumero,
                            or(
                              local!Impacto.TipoImpacto = 3,
                              local!Impacto.TipoImpacto = 4,
                              local!Impacto.TipoImpacto = 12
                            )
                          ),
                          a!save(
                            local!Impacto.Numero,
                            if(
                              local!mostrarNumero,
                              local!Impacto.Numero,
                              null
                            )
                          ),
                          if(
                            local!mostrarEconomico,
                            a!save(local!nulo,null),
                            a!save(
                              {local!Impacto.Importe,local!Impacto.Divisa,local!Impacto.TipoCambio,local!Impacto.ImporteLocal,local!Impacto.Cuenta},
                              null
                            )
                          )
                        },
                        disabled: and(
                          local!mostrarGeografia,
                          #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Geografias)
                        ),
                        validations: {}
                      )
                    }
                  ),
                  #"SYSTEM_SYSRULES_columnLayout"(
                    contents: {
                      #"SYSTEM_SYSRULES_dropdownField"(
                        label: index(ri!labels, "incidencia.geografia.estado-impacto"),
                        labelPosition: "ABOVE",
                        placeholderLabel: index(ri!labels,"general.placeholder-dropdown"),
                        choiceLabels: {#"_a-0000e4a8-06eb-8000-9ba2-011c48011c48_8560403"},
                        choiceValues: {enumerate(length(#"_a-0000e4a8-06eb-8000-9ba2-011c48011c48_8560403"))+1},
                        value: local!Impacto.Estado,
                        saveInto: {
                          local!Impacto.Estado,
                          if(
                            local!Impacto.Estado &lt;&gt; 2,
                            a!save(
                              {local!Impacto.FechaResolucion,local!Impacto.Resolucion},
                              null
                            ),
                            a!save(local!nulo,null)
                          )
                        },
                        disabled: and(
                          local!mostrarGeografia,
                          #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Geografias)
                        ),
                        validations: {}
                      )
                    }
                  ),
                  #"SYSTEM_SYSRULES_columnLayout"(
                    contents: {
                      #"SYSTEM_SYSRULES_integerField"(
                        label: index(ri!labels, "incidencia.geografia.numero"),
                        labelPosition: "ABOVE",
                        value: local!Impacto.Numero,
                        saveInto: local!Impacto.Numero,
                        disabled: and(
                          local!mostrarGeografia,
                          #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Geografias)
                        )
                      )
                    },
                    showWhen: local!mostrarNumero
                  ),
                  #"SYSTEM_SYSRULES_columnLayout"(
                    contents: {
                      #"SYSTEM_SYSRULES_multipleDropdownField"(
                        label: index(ri!labels, "incidencia.geografia.procesos-afectados"),
                        labelPosition: "ABOVE",
                        instructions: if(
                          #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Incidencia.Direcciones),
                          index(ri!labels, "incidencia.geografia.warning.selecciona-direccion"),
                          if(
                            local!queryProcesos.totalCount = 0,
                            index(ri!labels, "incidencia.geografia.warning.id-direccion-no-coincide"),
                            ""
                          )
                        ),
                        choiceLabels: {index(local!queryProcesos.data,"ProcesoAfectado",{})},
                        choiceValues: {index(local!queryProcesos.data,"IdProceso",{})},
                        value: local!Impacto.ProcesosAfectados,
                        saveInto: {local!Impacto.ProcesosAfectados},
                        disabled: or(
                          local!queryProcesos.totalCount = 0,
                          and(
                            local!mostrarGeografia,
                            #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Geografias)
                          )
                        ),
                        validations: {}
                      )
                    }
                  )
                }
              ),
              #"SYSTEM_SYSRULES_sideBySideLayout"(
                items: {
                  #"SYSTEM_SYSRULES_sideBySideItem"(
                    item: #"SYSTEM_SYSRULES_floatingPointField"(
                      label: index(ri!labels, "incidencia.geografia.importe"),
                      labelPosition: "ABOVE",
                      value: local!Impacto.Importe,
                      saveInto: local!Impacto.Importe
                      /*readOnly: ri!readOnly*/
                    )
                  ),
                  #"SYSTEM_SYSRULES_sideBySideItem"(
                    item: #"SYSTEM_SYSRULES_dropdownField"(
                      label: index(ri!labels, "incidencia.geografia.divisa"),
                      labelPosition: "ABOVE",
                      placeholderLabel: "--- Seleccionar un valor ---",
                      choiceLabels: {
                        if(
                          local!queryDivisas.totalCount = 0,
                          {},
                          #"SYSTEM_SYSRULES_forEach"(
                            local!queryDivisas.data,
                            joinarray(
                              {
                                fv!item.Codigo,
                                fv!item.Descripcion
                              },
                              " - "
                            )
                          )
                        )
                      },
                      choiceValues: {index(local!queryDivisas.data,"Id",{})},
                      value: local!Impacto.Divisa,
                      saveInto: {local!Impacto.Divisa},
                      disabled: #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.Importe),
                      validations: {}
                    )
                  ),
                  #"SYSTEM_SYSRULES_sideBySideItem"(
                    item: #"SYSTEM_SYSRULES_textField"(
                      label: index(ri!labels, "incidencia.geografia.tipo-cambio"),
                      labelPosition: "ABOVE",
                      value: local!Impacto.TipoCambio,
                      saveInto: {
                        a!save(
                          local!Impacto.TipoCambio,
                          todecimal(
                            if(
                              find(",",save!value),
                              substitute(save!value,",","."),
                              save!value
                            )
                          )
                        ),
                        a!save(
                          local!Impacto.ImporteLocal,
                          local!Impacto.Importe * local!Impacto.TipoCambio
                        )
                      },
                      disabled: #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.Importe)
                    )
                  ),
                  #"SYSTEM_SYSRULES_sideBySideItem"(
                    item: #"SYSTEM_SYSRULES_textField"(
                      label: index(ri!labels, "incidencia.geografia.importe-local"),
                      labelPosition: "ABOVE",
                      value: concat(local!Impacto.ImporteLocal, 
                        if(
                          ri!usuarioLogado.data.PaisEsp = "México",
                          "$",
                          "€"
                        )
                      ),
                      saveInto: {
                        a!save(
                          local!Impacto.ImporteLocal,
                          todecimal(
                            if(
                              find(",",save!value),
                              substitute(save!value,",","."),
                              save!value
                            )
                          )
                        ),
                        a!save(
                          local!Impacto.TipoCambio,
                          local!Impacto.ImporteLocal / local!Impacto.Importe 
                        )
                      },
                      disabled: #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.Importe)
                    )
                  ),
                  #"SYSTEM_SYSRULES_sideBySideItem"(
                    item: #"SYSTEM_SYSRULES_textField"(
                      label: index(ri!labels, "incidencia.geografia.cuenta"),
                      labelPosition: "ABOVE",
                      value: local!Impacto.Cuenta,
                      saveInto: local!Impacto.Cuenta,
                      disabled: #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.Importe),
                      validations: if(
                        len(
                          local!Impacto.Cuenta
                        ) &gt; 255,
                        "La longitud del valor no puede ser superior a 255 caracteres. Ha escrito " &amp; len(
                          local!Impacto.Cuenta
                        ) &amp; " caracteres.",
                        null
                      )
                    )
                  )

                },
                alignvertical: "MIDDLE",
                showWhen: local!mostrarEconomico
              ),
              #"SYSTEM_SYSRULES_columnsLayout"(
                columns: {
                  #"SYSTEM_SYSRULES_columnLayout"(
                    contents: {
                      #"SYSTEM_SYSRULES_paragraphField"(
                        label: index(ri!labels, "incidencia.geografia.descripcion"),
                        labelPosition: "ABOVE",
                        value: local!Impacto.Descripcion,
                        saveInto: local!Impacto.Descripcion,
                        height: "MEDIUM",
                        validations: if(
                          len(
                            local!Impacto.Descripcion
                          ) &gt; 1000,
                          "La longitud del valor no puede ser superior a 1000 caracteres. Ha escrito " &amp; len(
                            local!Impacto.Descripcion
                          ) &amp; " caracteres.",
                          null
                        ),
                        disabled: and(
                          local!mostrarGeografia,
                          #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Geografias)
                        )
                      )
                    }
                  ),
                  #"SYSTEM_SYSRULES_columnLayout"(
                    contents: {
                      #"SYSTEM_SYSRULES_textField"(
                        label: index(ri!labels, "incidencia.geografia.cliente-externo-afectado"),
                        labelPosition: "ABOVE",
                        value: local!Impacto.ClienteExternoAfectado,
                        saveInto: local!Impacto.ClienteExternoAfectado,
                        validations: if(
                          len(
                                  local!Impacto.ClienteExternoAfectado
                                ) &gt; 255,
                          "La longitud del valor no puede ser superior a 255 caracteres. Ha escrito " &amp; len(
                                  local!Impacto.ClienteExternoAfectado
                                ) &amp; " caracteres.",
                          null
                        ),
                        disabled: and(
                          local!mostrarGeografia,
                          #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Geografias)
                        )
                      ),
                      #"SYSTEM_SYSRULES_dateField"(
                        label: index(ri!labels, "incidencia.geografia.fecha-resolucion"),
                        labelPosition: "ABOVE",
                        value: local!Impacto.FechaResolucion,
                        saveInto: local!Impacto.FechaResolucion,
                        showWhen: local!Impacto.Estado = 2
                      ),
                      #"SYSTEM_SYSRULES_paragraphField"(
                        label: index(ri!labels, "incidencia.geografia.resolucion"),
                        labelPosition: "ABOVE",
                        value: local!Impacto.Resolucion,
                        saveInto: local!Impacto.Resolucion,
                        showWhen: local!Impacto.Estado = 2,
                        height: "SHORT",
                        validations: if(
                          len(
                            local!Impacto.Resolucion
                          ) &gt; 1000,
                          "La longitud del valor no puede ser superior a 1000 caracteres. Ha escrito " &amp; len(
                            local!Impacto.Resolucion
                          ) &amp; " caracteres.",
                          null
                        )
                      )
                    }
                  )
                }
              ),
              #"SYSTEM_SYSRULES_richTextDisplayField"(
                label: "Add",
                labelPosition: "COLLAPSED",
                value: {
                  #"SYSTEM_SYSRULES_richTextIcon"(
                    icon: "eraser",
                    caption: index(ri!labels, "general.limpiar"),
                    link: #"SYSTEM_SYSRULES_dynamicLink"(
                      saveInto: {
                        a!save(local!Impacto,'type!{urn:com:appian:types:RC}RC_CDT_Impacto'()),
                        a!save(local!IdSubImpacto,null)
                      }
                    ),
                    size: "MEDIUM"
                  ),
                  #"SYSTEM_SYSRULES_richTextItem_v1"(
                    text: repeat(1, char(9))
                  ),
                  #"SYSTEM_SYSRULES_richTextIcon"(
                    icon: "plus",
                    caption: index(ri!labels, "general.añadir"),
                    link: #"SYSTEM_SYSRULES_dynamicLink"(
                      value: {local!Impacto},
                      saveInto: {
                        a!save(
                          ri!Impactos,
                          append(
                            ri!Impactos,
                            local!Impacto
                          )
                        ),
                        a!save(
                          local!Impacto.ProcesosAfectados,
                          null
                        )
                      },
                      showWhen: not(
                        or(
                          and(
                            local!mostrarGeografia,
                            #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!IdSubImpacto)
                          ),
                          if(
                            #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.TipoImpacto),
                            true(),
                            if(
                              local!mostrarNumero,
                              #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.Numero),
                              if(
                                local!mostrarEconomico,
                                or(
                                  #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.Importe),
                                  #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.Divisa),
                                  #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.TipoCambio),
                                  #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.ImporteLocal)
                                ),
                                false()
                              )
                            )
                          ),
                          #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.Descripcion),
                          #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.ProcesosAfectados),
                          if(
                            local!Impacto.Estado = 2,
                            or(
                              #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.FechaResolucion),
                              #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!Impacto.Resolucion)                              
                            ),
                            false()
                          )
                        )
                      )
                    ),
                    size: "MEDIUM"
                  )
                },
                align: "RIGHT"
              ),
              with(
                local!diccionarioImpacto: if(
                  #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(ri!Impactos),
                  {},
                  #"SYSTEM_SYSRULES_forEach"(
                    ri!Impactos,
                    {
                      IdTemporal: fv!index,
                      Geoclisub: {},
                      IdTipo: fv!item.TipoImpacto,
                      TipoImpacto: index(local!queryImpactosIdioma.data.Nombre,wherecontains(fv!item.TipoImpacto,tointeger(local!queryImpactosIdioma.data.Id))),
                      Estado: index(#"_a-0000e4a8-06eb-8000-9ba2-011c48011c48_8560403",fv!item.Estado),
                      Numero: fv!item.Numero,
                      ProcesosAfectados: joinarray(index(local!queryProcesos.data.ProcesoAfectado,wherecontains(fv!item.ProcesosAfectados,tointeger(local!queryProcesos.data.IdProceso))),"; "),
                      Importe: fv!item.Importe,
                      Divisa: fv!item.Divisa,
                      TipoCambio: fv!item.TipoCambio,
                      ImporteLocal: fv!item.ImporteLocal,
                      Cuenta: fv!item.Cuenta
                    }
                  )
                ),
                local!datasubset: todatasubset(local!diccionarioImpacto,local!pagingImpacto),
                #"SYSTEM_SYSRULES_gridField"(
                  label: "Tabla impacto",
                  labelPosition: "COLLAPSED",
                  totalCount: local!datasubset.totalCount,
                  columns: {
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.geografia-cliente-sub"),
                      data: {},
                      showWhen: local!mostrarGeografia
                    ),
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.tipo-impacto"),
                      field: "TipoImpacto",
                      data: {index(local!datasubset.data,"TipoImpacto",{})}
                    ),
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.estado-impacto"),
                      field: "Estado",
                      data: {index(local!datasubset.data,"Estado",{})}
                    ),
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.numero"),
                      field: "Numero",
                      data: {
                        #"SYSTEM_SYSRULES_forEach"(
                          local!datasubset.data,
                          if(
                            #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(fv!item.Numero),
                            "N/A",
                            fv!item.Numero
                          )
                        )
                      },
                      showWhen: not(#"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(index(ri!Impactos,"Numero",{})))
                    ),
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.procesos-afectados"),
                      field: "ProcesosAfectados",
                      data: {index(local!datasubset.data,"ProcesosAfectados",{})}
                    ),
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.importe"),
                      field: "Importe",
                      data: {
                        if(
                          local!datasubset.totalCount = 0,
                          {},
                          #"SYSTEM_SYSRULES_forEach"(
                            local!datasubset.data,
                            if(
                              #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(fv!item.Importe),
                              "N/A",
                              fv!item.Importe
                            )
                          )
                        )
                      },
                      showWhen: not(#"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(index(ri!Impactos,"Importe",{})))
                    ),
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.divisa"),
                      field: "Divisa",
                      data: {
                        if(
                          local!datasubset.totalCount = 0,
                          {},
                          #"SYSTEM_SYSRULES_forEach"(
                            local!datasubset.data,
                            if(
                              #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(fv!item.Divisa),
                              "N/A",
                              fv!item.Divisa
                            )
                          )
                        )
                      },
                      showWhen: not(#"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(index(ri!Impactos,"Divisa",{})))
                    ),
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.tipo-cambio"),
                      field: "TipoCambio",
                      data: {
                        if(
                          local!datasubset.totalCount = 0,
                          {},
                          #"SYSTEM_SYSRULES_forEach"(
                            local!datasubset.data,
                            if(
                              #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(fv!item.TipoCambio),
                              "N/A",
                              fv!item.TipoCambio
                            )
                          )
                        )
                      },
                      showWhen: not(#"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(index(ri!Impactos,"TipoCambio",{})))
                    ),
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.importe-local"),
                      field: "ImporteLocal",
                      data: {
                        if(
                          local!datasubset.totalCount = 0,
                          {},
                          #"SYSTEM_SYSRULES_forEach"(
                            local!datasubset.data,
                            if(
                              #"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(fv!item.ImporteLocal),
                              "N/A",
                              concat(fv!item.ImporteLocal, 
                              if(
                                ri!usuarioLogado.data.PaisEsp = "México",
                                "$",
                                "€"
                              )
                              )
                            )
                          )
                        )
                      },
                      showWhen: not(#"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(index(ri!Impactos,"ImporteLocal",{})))
                    ),
                    #"SYSTEM_SYSRULES_gridTextColumn"(
                      label: index(ri!labels, "incidencia.geografia.cuenta"),
                      field: "Cuenta",
                      data: {
                        if(
                          local!datasubset.totalCount = 0,
                          {},
                          #"SYSTEM_SYSRULES_forEach"(
                            local!datasubset.data,
                            if(
                              or(
                                tointeger(fv!item.IdTipo) = 1,
                                tointeger(fv!item.IdTipo) = 2
                              ),
                              fv!item.Cuenta,
                              "N/A"
                            )
                          )
                        )
                      },
                      showWhen: not(#"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(index(ri!Impactos,"Cuenta",{})))
                    ),
                    #"SYSTEM_SYSRULES_gridImageColumn_v1"(
                      label: "",
                      data: if(
                        local!datasubset.totalCount = 0,
                        {},
                        #"SYSTEM_SYSRULES_forEach"(
                          local!datasubset.data,
                          #"SYSTEM_SYSRULES_documentImage"(
                            document: #"_a-0000e4a8-06eb-8000-9ba2-011c48011c48_8580837",
                            caption: index(ri!labels,"incidencia.geografia.binoculares"),
                            link: #"SYSTEM_SYSRULES_dynamicLink"(
                              value: fv!item.IdTemporal,
                              saveInto: local!mostrarMasInfo
                            )
                          )
                        )
                      )
                    ),
                    #"SYSTEM_SYSRULES_gridImageColumn_v1"(
                      label: "",
                      data: if(
                        local!datasubset.totalCount = 0,
                        {},
                        #"SYSTEM_SYSRULES_forEach"(
                          local!datasubset.data,
                          #"SYSTEM_SYSRULES_documentImage"(
                            document: #"SYSTEM_SYSRULES_iconIndicator"("REMOVE"),
                            caption: index(ri!labels,"general.eliminar"),
                            link: #"SYSTEM_SYSRULES_dynamicLink"(
                              value: remove(ri!Impactos, fv!item.IdTemporal),
                              saveInto: {
                                a!save(
                                  local!pagingImpacto.startIndex,
                                  if(
                                    and(
                                      local!datasubset.totalCount = local!pagingImpacto.startIndex,
                                      not(local!pagingImpacto.startIndex = 1)
                                    ),
                                    local!pagingImpacto.startIndex - local!pagingImpacto.batchSize,
                                    local!pagingImpacto.startIndex
                                  )
                                ),
                                ri!Impactos,
                                a!save(
                                  local!mostrarMasInfo,
                                  null
                                )
                              }
                            )
                          )
                        )
                      )
                    )
                  },
                  value: local!pagingImpacto,
                  saveInto: {local!pagingImpacto},
                  validations: {},
                  shadeAlternateRows: true
                )
              ),
              #"SYSTEM_SYSRULES_sideBySideLayout"(
                items: {}
              ),
              #"SYSTEM_SYSRULES_columnsLayout"(
                columns: {
                  #"SYSTEM_SYSRULES_columnLayout"(
                    contents: {
                      #"SYSTEM_SYSRULES_paragraphField"(
                        label: index(ri!labels, "incidencia.geografia.descripcion"),
                        readOnly: true(),
                        value: index(index(ri!Impactos,local!mostrarMasInfo,{}),"Descripcion",{})
                      ),
                      #"SYSTEM_SYSRULES_textField"(
                        label: index(ri!labels, "incidencia.geografia.cliente-externo-afectado"),
                        readOnly: true(),
                        value: index(index(ri!Impactos,local!mostrarMasInfo,{}),"ClienteExternoAfectado",{})
                      )
                    }
                  ),
                  #"SYSTEM_SYSRULES_columnLayout"(
                    contents: {
                      #"SYSTEM_SYSRULES_paragraphField"(
                        label: index(ri!labels, "incidencia.geografia.resolucion"),
                        readOnly: true(),
                        value: index(index(ri!Impactos,local!mostrarMasInfo,{}),"Resolucion",{})
                      ),
                      #"SYSTEM_SYSRULES_dateField"(
                        label: index(ri!labels, "incidencia.geografia.fecha-resolucion"),
                        readOnly: true(),
                        value: index(index(ri!Impactos,local!mostrarMasInfo,{}),"FechaResolucion",{})
                      )                     
                    },
                    showWhen: index(index(ri!Impactos,local!mostrarMasInfo,{}),"Estado",{}) = 2
                  )
                },
                showWhen: not(#"_a-0000e1f2-c7ff-8000-9ba2-011c48011c48_4159842"(local!mostrarMasInfo))
              )
            },
            style: "STANDARD",
            isCollapsible: true(),
            isInitiallyCollapsed: true(),
            marginBelow: "STANDARD"
          )
        },
        isCollapsible: true(),
        isInitiallyCollapsed: true()
      )
    }
  )
)</definition>
        <namedTypedValue>
            <name>labels</name>
            <type>
                <name>Variant</name>
                <namespace>http://www.appian.com/ae/types/2009</namespace>
            </type>
        </namedTypedValue>
        <namedTypedValue>
            <name>Incidencia</name>
            <type>
                <name>RC_CDT_ProcesoIncidencia</name>
                <namespace>urn:com:appian:types:RC</namespace>
            </type>
        </namedTypedValue>
        <namedTypedValue>
            <name>proceso</name>
            <type>
                <name>ProcessModel</name>
                <namespace>http://www.appian.com/ae/types/2009</namespace>
            </type>
        </namedTypedValue>
        <namedTypedValue>
            <name>Geografias</name>
            <type>
                <name>RC_CDT_Geografia?list</name>
                <namespace>urn:com:appian:types:RC</namespace>
            </type>
        </namedTypedValue>
        <namedTypedValue>
            <name>Impactos</name>
            <type>
                <name>RC_CDT_Impacto?list</name>
                <namespace>urn:com:appian:types:RC</namespace>
            </type>
        </namedTypedValue>
        <namedTypedValue>
            <name>idiomaEsp</name>
            <type>
                <name>boolean</name>
                <namespace>http://www.w3.org/2001/XMLSchema</namespace>
            </type>
        </namedTypedValue>
        <namedTypedValue>
            <name>usuarioLogado</name>
            <type>
                <name>DataSubset</name>
                <namespace>http://www.appian.com/ae/types/2009</namespace>
            </type>
        </namedTypedValue>
        <preferredEditor>interface</preferredEditor>
        <offlineEnabled>false</offlineEnabled>
    </rule>
    <roleMap public="true">
        <role inherit="true" allowForAll="false" name="readers">
            <users/>
            <groups/>
        </role>
        <role inherit="true" allowForAll="false" name="authors">
            <users/>
            <groups/>
        </role>
        <role inherit="true" allowForAll="false" name="administrators">
            <users/>
            <groups/>
        </role>
        <role inherit="false" allowForAll="false" name="denyReaders">
            <users/>
            <groups/>
        </role>
        <role inherit="false" allowForAll="false" name="denyAuthors">
            <users/>
            <groups/>
        </role>
        <role inherit="false" allowForAll="false" name="denyAdministrators">
            <users/>
            <groups/>
        </role>
    </roleMap>
    <typedValue>
        <type>
            <name>RuleTestConfig?list</name>
            <namespace>http://www.appian.com/ae/types/2009</namespace>
        </type>
        <value>
            <el>
                <a:name/>
                <a:ruleInputTestConfigs>
                    <a:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="a:Expression">#"_a-0000e480-7e67-8000-9ba2-011c48011c48_8412556"()</a:value>
                    <a:nameRef>labels</a:nameRef>
                    <a:id>1</a:id>
                </a:ruleInputTestConfigs>
                <a:ruleInputTestConfigs>
                    <a:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="a:Expression">'type!{urn:com:appian:types:RC}RC_CDT_ProcesoIncidencia'('DatosGenerales': 'type!{urn:com:appian:types:RC}RC_CDT_Incidencia'('EventoRiesgosPropiosHeracles': false), 'Direcciones': {'type!{urn:com:appian:types:RC}RC_CDT_DireccionesAreasIncidencias'('IdDireccionArea': 1, 'Afectada': true, 'ctlFechaModificacion': fn!datetime(2020, 6, 22, 9, 40, 40, 755), 'ctlUsuarioModificacion': "X333603", 'ctlFechaCreacion': fn!datetime(2020, 6, 22, 9, 40, 40, 755), 'ctlUsuarioCreacion': "X333603", 'ctlEstado': true)})</a:value>
                    <a:nameRef>Incidencia</a:nameRef>
                    <a:id>2</a:id>
                </a:ruleInputTestConfigs>
                <a:ruleInputTestConfigs>
                    <a:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:nil="true" xsi:type="a:ProcessModel"/>
                    <a:nameRef>proceso</a:nameRef>
                    <a:id>3</a:id>
                </a:ruleInputTestConfigs>
                <a:ruleInputTestConfigs>
                    <a:nameRef>Geografias</a:nameRef>
                    <a:id>4</a:id>
                </a:ruleInputTestConfigs>
                <a:ruleInputTestConfigs>
                    <a:nameRef>Impactos</a:nameRef>
                    <a:id>5</a:id>
                </a:ruleInputTestConfigs>
                <a:ruleInputTestConfigs>
                    <a:value xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xsd:boolean">true</a:value>
                    <a:nameRef>idiomaEsp</a:nameRef>
                    <a:id>6</a:id>
                </a:ruleInputTestConfigs>
                <a:ruleInputTestConfigs>
                    <a:value xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="a:Expression">#"_a-0000e4a8-06eb-8000-9ba2-011c48011c48_8560119"(Usuario: loggedInUser())</a:value>
                    <a:nameRef>usuarioLogado</a:nameRef>
                    <a:id/>
                </a:ruleInputTestConfigs>
                <a:assertions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:nil="true"/>
            </el>
        </value>
    </typedValue>
    <history>
        <historyInfo versionUuid="_a-0000e4a8-06eb-8000-9ba2-011c48011c48_8583393"/>
    </history>
</contentHaul>
